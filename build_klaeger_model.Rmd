---
title: "Build Klaeger Model"
author: "Matthew Berginski"
date: "12/10/2020"
output: html_document
---

```{r setup, include=FALSE}
library(tidymodels)
library(tidyverse)
library(yardstick)
library(tictoc)
library(here)
```


```{r}
klaeger_data = read_csv(here('data/Klaeger-All.csv')) %>%
	#all of the results with growth 10 don't have a match from the GR vals, remove them
	filter(Growth != 10) %>%
	select(-Drug, -Concentration)

linear_model = linear_reg() %>% 
	set_engine("lm") %>%
	fit(Growth ~ ., data=klaeger_data)


```

```{r}
tic()
folds <- vfold_cv(klaeger_data, v = 10)

metrics = data.frame()

for (num_trees in seq(1000,5000,by=1000)) {
	
	rf_mod <- 
		rand_forest(trees = num_trees) %>% 
		set_engine("ranger") %>% 
		set_mode("regression")
	
	rf_wf <- 
		workflow() %>%
		add_model(rf_mod) %>%
		add_formula(Growth ~ .)
	
	rf_fit_rs <-
		rf_wf %>%
		fit_resamples(folds)
	
	metrics = rbind(
		metrics,
		collect_metrics(rf_fit_rs) %>% mutate(num_trees = num_trees)
	)
	
}
toc()
# rf_fit = rf_mod %>%
# 	fit(Growth ~ ., data = klaeger_data)

```

```{r}
prediction_results = c()

tic()
for (exclude_row in 1:dim(klaeger_data)[1]) {
	# for (exclude_row in 1:10) {
	klaeger_train = klaeger_data[-exclude_row,]
	klaeger_test = klaeger_data[exclude_row,]
	
	rf_mod <- 
		rand_forest(trees = 1000) %>% 
		set_engine("ranger") %>% 
		set_mode("regression")
	
	rf_wf <- 
		workflow() %>%
		add_model(rf_mod) %>%
		add_formula(Growth ~ .)
	
	rf_fit_rs <-
		rf_mod %>%
		fit(Growth ~ ., data = klaeger_train)
	
	prediction_results = c(prediction_results,
												 predict(rf_fit_rs,klaeger_test)$.pred)
}

klaeger_LOO_results = data.frame(true_growth = klaeger_data$Growth,predicted_growth_RF = prediction_results)
toc()
```

```{r}

ggplot(klaeger_LOO_results, aes(x=true_growth, y=predicted_growth_RF)) + 
	geom_point() +
	geom_smooth(method='lm') +
	ylim(c(-1,1)) + xlim(c(-1,1)) +
	labs(x="True Growth Rate",y="Random Forest Prediction") +
	BerginskiRMisc::theme_berginski()

```

```{r}
prediction_results_lm = c()

tic()
for (exclude_row in 1:dim(klaeger_data)[1]) {
	# for (exclude_row in 1:10) {
	klaeger_train = klaeger_data[-exclude_row,]
	klaeger_test = klaeger_data[exclude_row,]
	
	lm_fit <- 
		linear_reg() %>% 
		set_engine("lm") %>%
		fit(Growth ~ ., data = klaeger_train)
	
	prediction_results_lm = c(prediction_results_lm,
														predict(lm_fit,klaeger_test)$.pred)
}

# klaeger_LOO_results$predicted_growth_LM = prediction_results_lm
toc()
```

```{r}
prediction_results_NN = c()

tic()
for (exclude_row in 1:dim(klaeger_data)[1]) {
# for (exclude_row in 1:10) {
	klaeger_train = klaeger_data[-exclude_row,]
	klaeger_test = klaeger_data[exclude_row,]
	
	lm_fit <- 
		mlp(epochs = 20, hidden_units = 5, dropout = 0.1) %>%
		set_engine("keras") %>%
		set_mode('regression') %>%
		fit(Growth ~ ., data = klaeger_train)
	
	prediction_results_NN = c(prediction_results_NN,
														predict(lm_fit,klaeger_test)$.pred)
}

klaeger_LOO_results$prediction_results_NN = prediction_results_NN
toc()
```



