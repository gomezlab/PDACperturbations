---
title: "Make Klaeger Synergy Viability Predictions"
author: "Matthew Berginski"
date: "`r Sys.Date()`"
output: github_document
---

```{r setup, include=FALSE}
library(tidymodels)
library(tidyverse)
library(yardstick)
library(tictoc)
library(here)
library(patchwork)
library(ggpubr)
library(MESS)
library(gridExtra)

options(scipen=999)
```

# Read In and Combine Klaeger/Synergy Data

The first step for the prediction pipeline is the same as for the model testing and production pipeline. Namely, read in the pre-processed Klaeger data and then combine it with the appropriate synergy screen results. Then, using this combined data set, build models for each of the cell lines.

```{r, include=F}
klaeger_data = read_rds(here('data/klaeger_full_tidy.rds'))

klaeger_data_wide = klaeger_data %>%
	pivot_wider(names_from = gene_name, values_from = relative_intensity)

```

```{r combine synergy and klaeger, include=F}
synergy_data_only_single = read_rds(here('data/synergy_combined.rds')) %>%
	mutate(anchor_lower = tolower(anchor),
				 compound_lower = tolower(compound)) %>%
	filter(dose_anchor_m == 0 | dose_compound_m == 0)

compound_matches = read_csv(here('data/DrugMatches.csv')) %>%
	#removing one of the alisertib compound matches that aren't in my copy of the synergy
	filter(pdac != "mln8237")

klaeger_data_matches = klaeger_data_wide %>%
	#All of the Klaeger data with zero compound concentration are 1 across the
	#board, also I have no particular way to match up the the no-treatments with
	#all the no-treatments from the synergy screen.
	filter(concentration_M != 0) %>%
	mutate(drug_lower = tolower(drug)) %>%
	filter(drug_lower %in% compound_matches$klaeger) %>%
	left_join(compound_matches, by=c('drug_lower'='klaeger')) %>%
	select(drug,drug_lower,pdac,everything())

klaeger_data_matches_compound = klaeger_data_matches %>% 
	left_join(synergy_data_only_single %>% 
							filter(dose_anchor_m == 0) %>%
							select(compound_lower,dose_compound_m,viability,cell_line), 
						by=c('pdac' = 'compound_lower', 'concentration_M' = 'dose_compound_m')) %>%
	select(drug,drug_lower,pdac,cell_line,viability,everything()) %>%
	filter(!is.na(viability))

klaeger_data_matches_anchor = klaeger_data_matches %>% 
	left_join(synergy_data_only_single %>% 
							filter(dose_compound_m == 0) %>%
							select(anchor_lower,dose_anchor_m,viability,cell_line), 
						by=c('pdac' = 'anchor_lower', 'concentration_M' = 'dose_anchor_m')) %>%
	select(drug,drug_lower,pdac,cell_line,viability,everything()) %>%
	filter(!is.na(viability))

klaeger_data_matches_full = bind_rows(
	klaeger_data_matches_compound,
	klaeger_data_matches_anchor
) %>% 
	mutate(viability_binary_90 = as.factor(viability < 90),
				 viability_binary_40 = as.factor(viability < 40)) %>%
	select(drug,drug_lower,pdac,cell_line,viability,viability_binary_90,viability_binary_40,everything())

klaeger_data_matches_tidy = klaeger_data %>% 
	filter(drug %in% unique(klaeger_data_matches_full$drug), 
				 concentration_M %in% unique(klaeger_data_matches_full$concentration_M))

no_gene_variation = klaeger_data_matches_tidy %>%
	group_by(gene_name) %>%
	summarise(gene_sd = sd(relative_intensity)) %>%
	filter(gene_sd == 0)

klaeger_data_matches_full = klaeger_data_matches_full %>%
	select(-one_of(no_gene_variation$gene_name))
```
```{r, include=F}
klaeger_prediction_data_tidy = klaeger_data %>%
	filter(! drug %in% klaeger_data_matches_full$drug) %>%
	filter(! gene_name %in% no_gene_variation$gene_name)

per_treatment_sd = klaeger_prediction_data_tidy %>% 
	group_by(drug, concentration_M) %>% 
	summarise(intensity_sd = sd(relative_intensity))

klaeger_prediction_data_tidy = klaeger_prediction_data_tidy %>%
	left_join(per_treatment_sd) %>%
	filter(intensity_sd > 0)

klaeger_prediction_wide = klaeger_prediction_data_tidy %>%
	pivot_wider(names_from = gene_name, values_from = relative_intensity) %>%
	select(-intensity_sd)

num_total_drugs = length(unique(c(klaeger_data_matches_full$drug,klaeger_prediction_wide$drug)))

num_possible_combinations = num_total_drugs^2/2 - num_total_drugs
```

First a few facts about the compounds/concentrations used for the model construction and predictions:

* \# of Compounds Used for Model Construction: `r length(unique(klaeger_data_matches_tidy$drug))`
* \# of Compound/Concentration Combinations in Model Construction: `r length(unique(paste0(klaeger_data_matches_tidy$drug,klaeger_data_matches_tidy$concentration_M)))`
* \# of Compounds in Prediction Set: `r length(unique(klaeger_prediction_data_tidy$drug))`
* \# of Compound/Concentration Combinations in Prediction Set: `r length(unique(paste0(klaeger_prediction_wide$drug,klaeger_prediction_wide$concentration_M)))`

Assuming we'd like to test all of the drugs (`r num_total_drugs` total) in combination (`r num_possible_combinations` combinations) at 6 concentrations for each compound. The total number of assays to run would be `r num_possible_combinations*36`, which would need `r ceiling(num_possible_combinations*36/384)` 384 well plates per cell line.

# Modeling

## Random Forest - Below 90 Models

```{r, cache=T}
tic()

binary_90_models = list()

prediction_results = c()
for (this_cell_line in unique(klaeger_data_matches_full$cell_line)) {
	
	klaeger_data_cell_line = klaeger_data_matches_full %>%
		filter(cell_line == this_cell_line) %>%
		select(-drug,-drug_lower,-pdac,-concentration_M,-cell_line,-viability,-viability_binary_40) 
	
	rf_mod <-
		rand_forest(trees = 1000) %>%
		set_engine("ranger", num.threads = 12) %>%
		set_mode("classification")
	
	binary_90_models[[this_cell_line]] <-
		rf_mod %>%
		fit(viability_binary_90 ~ ., data = klaeger_data_cell_line)
}
toc()
```
## Random Forest - Below 40 Models

```{r, cache=T}
tic()

binary_40_models = list()

prediction_results = c()
for (this_cell_line in unique(klaeger_data_matches_full$cell_line)) {
	
	klaeger_data_cell_line = klaeger_data_matches_full %>%
		filter(cell_line == this_cell_line) %>%
		select(-drug,-drug_lower,-pdac,-concentration_M,-cell_line,-viability,-viability_binary_90) 
	
	rf_mod <-
		rand_forest(trees = 1000) %>%
		set_engine("ranger", num.threads = 12) %>%
		set_mode("classification")
	
	binary_40_models[[this_cell_line]] <-
		rf_mod %>%
		fit(viability_binary_40 ~ ., data = klaeger_data_cell_line)
}
toc()
```


# Predictions

## Below 90

```{r}
below_90_predictions = data.frame()

klaeger_prediction_wide_model_set = klaeger_prediction_wide %>%
	select(-drug,-concentration_M)

for (this_cell_line in names(binary_90_models)) {
	this_cell_predictions = data.frame(
		drug = klaeger_prediction_wide$drug,
		concentration_M = klaeger_prediction_wide$concentration_M,
		cell_line = this_cell_line,
		prob_below_90 = predict(binary_90_models[[this_cell_line]],klaeger_prediction_wide_model_set, type="prob")$.pred_TRUE)

	below_90_predictions = bind_rows(
		below_90_predictions,
		this_cell_predictions
	)
}

below_90_predictions_cell = below_90_predictions %>% 
	pivot_wider(names_from = "cell_line", values_from = "prob_below_90") %>%
	mutate(caf_naf_diff = NAF - CAF)
```

```{r}
ggplot(below_90_predictions, aes(x=prob_below_90)) + geom_histogram()
```

```{r}
ggplot(below_90_predictions, aes(x=prob_below_90)) + geom_histogram() + facet_wrap(~cell_line)
```

## Below 40

```{r}
below_40_predictions = data.frame()

klaeger_prediction_wide_model_set = klaeger_prediction_wide %>%
	select(-drug,-concentration_M)

for (this_cell_line in names(binary_40_models)) {
	this_cell_predictions = data.frame(
		drug = klaeger_prediction_wide$drug,
		concentration_M = klaeger_prediction_wide$concentration_M,
		cell_line = this_cell_line,
		prob_below_40 = predict(binary_40_models[[this_cell_line]],klaeger_prediction_wide_model_set, type="prob")$.pred_TRUE)

	below_40_predictions = bind_rows(
		below_40_predictions,
		this_cell_predictions
	)
}
```

```{r}
ggplot(below_40_predictions, aes(x=prob_below_40)) + geom_histogram()
```

```{r}
ggplot(below_40_predictions, aes(x=prob_below_40)) + geom_histogram() + facet_wrap(~cell_line)
```

