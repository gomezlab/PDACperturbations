---
title: "Klaeger Synergy Viability Predictions"
author: "Matthew Berginski"
date: "`r Sys.Date()`"
output: github_document
---

```{r setup, include=FALSE}
library(tidymodels)
library(tidyverse)
library(yardstick)
library(tictoc)
library(here)
library(patchwork)
library(ggpubr)
library(MESS)
library(gridExtra)

options(scipen=999)
knitr::opts_knit$set(root.dir = here(), include = F)
```

# Read In and Combine Klaeger/Synergy Data

The first step for the prediction pipeline is the same as for the model testing and production pipeline. Namely, read in the pre-processed Klaeger data and then combine it with the appropriate synergy screen results. Then, using this combined data set, build models for each of the cell lines.

```{r, include=F}
klaeger_data = read_rds(here('data/klaeger_full_tidy.rds'))

klaeger_data_wide = klaeger_data %>%
	pivot_wider(names_from = gene_name, values_from = relative_intensity)

```

```{r combine synergy and klaeger, include=F}
synergy_data_only_single = read_rds(here('data/synergy_combined.rds')) %>%
	mutate(anchor_lower = tolower(anchor),
				 compound_lower = tolower(compound)) %>%
	filter(dose_anchor_m == 0 | dose_compound_m == 0) %>%
	#there was a problem with the NAF cell line, removing from data set
	filter(cell_line != "NAF")

compound_matches = read_csv(here('data/DrugMatches.csv')) %>%
	#removing one of the alisertib compound matches that aren't in my copy of the synergy
	filter(pdac != "mln8237")

klaeger_data_matches = klaeger_data_wide %>%
	#All of the Klaeger data with zero compound concentration are 1 across the
	#board, also I have no particular way to match up the the no-treatments with
	#all the no-treatments from the synergy screen.
	filter(concentration_M != 0) %>%
	mutate(drug_lower = tolower(drug)) %>%
	filter(drug_lower %in% compound_matches$klaeger) %>%
	left_join(compound_matches, by=c('drug_lower'='klaeger')) %>%
	select(drug,drug_lower,pdac,everything())

klaeger_data_matches_compound = klaeger_data_matches %>% 
	left_join(synergy_data_only_single %>% 
							filter(dose_anchor_m == 0) %>%
							select(compound_lower,dose_compound_m,viability,cell_line), 
						by=c('pdac' = 'compound_lower', 'concentration_M' = 'dose_compound_m')) %>%
	select(drug,drug_lower,pdac,cell_line,viability,everything()) %>%
	filter(!is.na(viability))

klaeger_data_matches_anchor = klaeger_data_matches %>% 
	left_join(synergy_data_only_single %>% 
							filter(dose_compound_m == 0) %>%
							select(anchor_lower,dose_anchor_m,viability,cell_line), 
						by=c('pdac' = 'anchor_lower', 'concentration_M' = 'dose_anchor_m')) %>%
	select(drug,drug_lower,pdac,cell_line,viability,everything()) %>%
	filter(!is.na(viability))

klaeger_data_matches_full = bind_rows(
	klaeger_data_matches_compound,
	klaeger_data_matches_anchor
) %>% 
	mutate(viability_binary_90 = as.factor(viability < 90),
				 viability_binary_40 = as.factor(viability < 40)) %>%
	select(drug,drug_lower,pdac,cell_line,viability,viability_binary_90,viability_binary_40,everything())

klaeger_data_matches_tidy = klaeger_data %>% 
	filter(drug %in% unique(klaeger_data_matches_full$drug), 
				 concentration_M %in% unique(klaeger_data_matches_full$concentration_M))

no_gene_variation = klaeger_data_matches_tidy %>%
	group_by(gene_name) %>%
	summarise(gene_sd = sd(relative_intensity)) %>%
	filter(gene_sd == 0)

klaeger_data_matches_full = klaeger_data_matches_full %>%
	select(-one_of(no_gene_variation$gene_name))
```

```{r, include=F}
klaeger_prediction_data_tidy = klaeger_data %>%
	filter(! drug %in% klaeger_data_matches_full$drug) %>%
	filter(! gene_name %in% no_gene_variation$gene_name)

per_treatment_sd = klaeger_prediction_data_tidy %>% 
	group_by(drug, concentration_M) %>% 
	summarise(intensity_sd = sd(relative_intensity))

klaeger_prediction_data_tidy = klaeger_prediction_data_tidy %>%
	left_join(per_treatment_sd) %>%
	filter(intensity_sd > 0)

klaeger_prediction_wide = klaeger_prediction_data_tidy %>%
	pivot_wider(names_from = gene_name, values_from = relative_intensity) %>%
	select(-intensity_sd)

num_total_drugs = length(unique(c(klaeger_data_matches_full$drug,klaeger_prediction_wide$drug)))

num_possible_combinations = num_total_drugs^2/2 - num_total_drugs
```

First a few facts about the compounds/concentrations used for the model construction and predictions:

* \# of Compounds Used for Model Construction: `r length(unique(klaeger_data_matches_tidy$drug))`
* \# of Compound/Concentration Combinations in Model Construction: `r length(unique(paste0(klaeger_data_matches_tidy$drug,klaeger_data_matches_tidy$concentration_M)))`
* \# of Compounds in Prediction Set: `r length(unique(klaeger_prediction_data_tidy$drug))`
* \# of Compound/Concentration Combinations in Prediction Set: `r length(unique(paste0(klaeger_prediction_wide$drug,klaeger_prediction_wide$concentration_M)))`

Assuming we'd like to test all of the drugs (`r num_total_drugs` total) in combination (`r num_possible_combinations` combinations) at 6 concentrations for each compound. The total number of assays to run would be `r num_possible_combinations*36`, which would need `r ceiling(num_possible_combinations*36/384)` 384 well plates per cell line.

# Modeling

Build two sets of random forest models, one to predict whether a compound at a concentration will cause cell viability to dip below 90% and another to predict cell viability below 40%. Unique models are built for each of the cell lines in the data set.

```{r, cache = T, include = F}
tic()

binary_90_models = list()

prediction_results = c()
for (this_cell_line in unique(klaeger_data_matches_full$cell_line)) {
	
	klaeger_data_cell_line = klaeger_data_matches_full %>%
		filter(cell_line == this_cell_line) %>%
		select(-drug,-drug_lower,-pdac,-concentration_M,-cell_line,-viability,-viability_binary_40) 
	
	rf_mod <-
		rand_forest(trees = 5000) %>%
		set_engine("ranger", num.threads = 12) %>%
		set_mode("classification")
	
	binary_90_models[[this_cell_line]] <-
		rf_mod %>%
		fit(viability_binary_90 ~ ., data = klaeger_data_cell_line)
}
toc()
```

```{r, cache=T, include = F}
tic()

binary_40_models = list()

prediction_results = c()
for (this_cell_line in unique(klaeger_data_matches_full$cell_line)) {
	
	klaeger_data_cell_line = klaeger_data_matches_full %>%
		filter(cell_line == this_cell_line) %>%
		select(-drug,-drug_lower,-pdac,-concentration_M,-cell_line,-viability,-viability_binary_90) 
	
	rf_mod <-
		rand_forest(trees = 5000) %>%
		set_engine("ranger", num.threads = 12) %>%
		set_mode("classification")
	
	binary_40_models[[this_cell_line]] <-
		rf_mod %>%
		fit(viability_binary_40 ~ ., data = klaeger_data_cell_line)
}
toc()
```

# Make Predictions Using Models

Now to use the models to make predictions on the remainder of the compounds in the Klaeger data set and build a few plots showing the distribution of viability predictions.

## Below 90% Cell Viability

```{r, include = F}
below_90_predictions = data.frame()

klaeger_prediction_wide_model_set = klaeger_prediction_wide %>%
	select(-drug,-concentration_M)

for (this_cell_line in names(binary_90_models)) {
	this_cell_predictions = data.frame(
		drug = klaeger_prediction_wide$drug,
		concentration_M = klaeger_prediction_wide$concentration_M,
		cell_line = this_cell_line,
		prob_below_90 = predict(binary_90_models[[this_cell_line]],klaeger_prediction_wide_model_set, type="prob")$.pred_TRUE)
	
	below_90_predictions = bind_rows(
		below_90_predictions,
		this_cell_predictions
	)
}
```

```{r, echo = F}
ggplot(below_90_predictions, aes(x=prob_below_90)) + 
	geom_histogram(breaks = seq(0,1,by=0.05)) +
	labs(x="Predicted Probability Below 90%", y = "Number of Drug/Concentration Combinations") +
	BerginskiRMisc::theme_berginski()
```

```{r, echo = F}
ggplot(below_90_predictions, aes(x=prob_below_90)) + 
	geom_histogram(breaks = seq(0,1,by=0.05)) + 
	labs(x="Predicted Probability Below 90%", y = "Number of Drug/Concentration Combinations") +
	BerginskiRMisc::theme_berginski() +
	facet_wrap(~cell_line)
```

## Below 40% Cell Viability

```{r, include = F}
below_40_predictions = data.frame()

klaeger_prediction_wide_model_set = klaeger_prediction_wide %>%
	select(-drug,-concentration_M)

for (this_cell_line in names(binary_40_models)) {
	this_cell_predictions = data.frame(
		drug = klaeger_prediction_wide$drug,
		concentration_M = klaeger_prediction_wide$concentration_M,
		cell_line = this_cell_line,
		prob_below_40 = predict(binary_40_models[[this_cell_line]],klaeger_prediction_wide_model_set, type="prob")$.pred_TRUE)
	
	below_40_predictions = bind_rows(
		below_40_predictions,
		this_cell_predictions
	)
}
```

```{r, echo = F}
ggplot(below_40_predictions, aes(x=prob_below_40)) + 
	geom_histogram(breaks = seq(0,1,by=0.05)) +
	labs(x="Predicted Probability Below 40%", y = "Number of Drug/Concentration Combinations") +
	BerginskiRMisc::theme_berginski()
```

```{r, echo = F}
ggplot(below_40_predictions, aes(x=prob_below_40)) + 
	geom_histogram(breaks = seq(0,1,by=0.05)) + 
	labs(x="Predicted Probability Below 40%", y = "Number of Drug/Concentration Combinations") +
	BerginskiRMisc::theme_berginski() +
	facet_wrap(~cell_line)
```

# Looking for Compounds to Test - Below 90 Predictions

With predictions of the likelihood that the compounds will push cell viability below 90% or below 40%, the next step is to try to use these predictions to pick out compound that are likely to have interesting viability results. As for what interesting means, I've collected four types of interesting results:

* Compounds with Low Predicted Effect on Viability: Pick out the compounds that are predicted to have no/minimal effect on viability. This might seem to be the least interesting type of prediction at first, but a model is only as good as it's ability to predict negative as well as positive results.
* Compounds with High Predicted Effect on Viability: Pick out the compounds that are predicted to strongly decrease cell viability.
* Compounds with Large Differences across Concentrations: Pick out compounds where the likelihood of affecting cell viability changes across the predicted concentrations. These should be compounds where low concentrations don't affect cell viability, while high concentrations start to inhibit cell growth.
* Compounds with Large Differences across Cell Lines: Pick out the compounds with large differences between the cell lines. This one seems kind of obvious as well, but if the model predicts large differences between the cell lines, this is probably worth testing

As for calculating all these, I've taken an approach that looks across all the cell lines simultaneously. Searching for across the board low effect and high effects is done by looking for the lowest and highest average probability on a per compound basis. Searching for large differences across concentrations is done by looking for the compounds with the highest range between probabilities. The final criteria (differences between cell lines) is a bit tougher to quantify, but what I've done is:

* matched up all the predictions across compound and concentration for each cell line
* calculated the absolute value of all the combination of differences in probability value
	+ We have three cell lines here (CAF, P1004 and P1304), so three combinations (CAF/P1004), (CAF/P1304) and (P1004/P1304)
* find the compounds with the largest mean value across all differences

```{r, include=F}
below_90_diffs = below_90_predictions %>%
	group_by(drug) %>%
	summarise(prob_diff = max(prob_below_90) - min(prob_below_90),
						mean_prob = mean(prob_below_90))

cell_line_diffs = below_90_predictions %>% 
	select(drug,concentration_M,cell_line,prob_below_90) %>% 
	pivot_wider(names_from = cell_line, values_from = prob_below_90) %>%
	mutate(CAF_P1004_diff = abs(CAF - P1004),
				 CAF_P1304_diff = abs(CAF - P1304),
				 P1004_P1304_diff = abs(P1004 - P1304)) %>%
	select(drug, contains("diff")) %>%
	pivot_longer(-drug,names_to = "diff_type", values_to = "diff_value") %>%
	group_by(drug) %>%
	summarise(aver_diff = mean(diff_value)) %>%
	identity()

below_90_predictions = below_90_predictions %>% 
	left_join(below_90_diffs) %>%
	left_join(cell_line_diffs) %>%
	# Let's suppose you want to show these results without revealing the name of
	# the compounds predicted. The following line runs the names of the drugs
	# through md5 giving a deterministic string that you can use to label the
	# drugs. This is probably a step too far in terms of double blinding an
	# experiment, but want to leave this here, just in case I need it later.
	
	#mutate(drug_anon = openssl::md5(drug)) %>%
	
	identity()
```

```{r, include = F}
build_probablity_plots <- function(data_set) {
	ggplot(data_set,aes(x = log10(concentration_M),
											y = prob_below_90, 
											color = cell_line)) +
		geom_point() +
		geom_line() +
		ylim(c(0,1)) +
		labs(x="Log 10 Compound Concentration (µM)", 
				 y="Predicted Probability of Cell Viability Below 90%",
				 color="Cell Line") +
		BerginskiRMisc::theme_berginski() +
		facet_wrap(~drug)
}
```

## Compounds with Low Predicted Effect

```{r, echo = F, fig.width = 10}
ten_lowest_effect = below_90_diffs %>%
	arrange(mean_prob) %>%
	slice(1:10)

below_90_predictions %>%
	mutate(drug = fct_relevel(drug,ten_lowest_effect$drug)) %>%
	filter(drug %in% ten_lowest_effect$drug) %>%
	build_probablity_plots()
```

## Compounds with High Predicted Effect

```{r, echo = F}
ten_highest_effect = below_90_diffs %>%
	arrange(desc(mean_prob)) %>%
	slice(1:10)

below_90_predictions %>%
	mutate(drug = fct_relevel(drug,ten_highest_effect$drug)) %>%
	filter(drug %in% ten_highest_effect$drug) %>%
	build_probablity_plots()
```

## Compounds with High Predicted Differences Across Concentrations

```{r, echo = F}
ten_highest_diff = below_90_diffs %>%
	arrange(desc(prob_diff)) %>%
	slice(1:10)

below_90_predictions %>%
	mutate(drug = fct_relevel(drug,ten_highest_diff$drug)) %>%
	filter(drug %in% ten_highest_diff$drug) %>%
	build_probablity_plots()
```

## Compounds with High Predicted Differences Between Cell Lines

```{r, echo = F}
ten_highest_cell_diff = cell_line_diffs %>%
	arrange(desc(cell_line_diffs$aver_diff)) %>%
	slice(1:10)

below_90_predictions %>%
	mutate(drug = fct_relevel(drug,ten_highest_cell_diff$drug)) %>%
	filter(drug %in% ten_highest_cell_diff$drug) %>%
	build_probablity_plots()
```