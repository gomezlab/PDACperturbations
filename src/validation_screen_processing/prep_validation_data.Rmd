---
title: "Prep Validation Screen Data"
author: "Matthew Berginski"
date: "`r Sys.Date()`"
output: github_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(here)
library(readxl)

knitr::opts_knit$set(root.dir = here())
```

# Read in plate data

All the data from the plate reader is collected into a set of excel spreadsheets. The luminescence values show up at the bottom of the spreadsheet. I've manually matched up the names of the excel files to the appropriate cell line names and compounds in each plate. There is a text file with the same information in the same data folder I've read these files from.

The plate is organized with the concentrations decreasing over each column of the plate, following the concentration used in Klaeger. The last two columns in each plate are DMSO controls.

```{r}
read_plate_data <- function(file_name,these_compounds,this_cell_line,skip_lines = 16) {

	temp_plate = read_excel(file_name, skip = skip_lines) %>%
		select(-A, -`...2`) %>%
		slice(1:6) %>%
		mutate(compound = c(rep(these_compounds[1],3),rep(these_compounds[2],3))) %>%
		pivot_longer(-compound, names_to = "concentration_M",values_to = "lum") %>%
		mutate(cell_line = this_cell_line, plate_name = basename(file_name)) %>%
		identity()
	
	DMSO_vals = temp_plate %>%
		filter(concentration_M == "...11" | concentration_M == "...12") %>%
		mutate(concentration_M = 0) %>%
		mutate(compound = "DMSO")
	
	temp_plate = temp_plate %>%
		filter(concentration_M != "...11", concentration_M != "...12") %>%
		mutate(concentration_M = case_when(
			concentration_M == "...3" ~ 3e-5,
			concentration_M == "...4" ~ 3e-6,
			concentration_M == "...5" ~ 1e-6,
			concentration_M == "...6" ~ 3e-7,
			concentration_M == "...7" ~ 1e-7,
			concentration_M == "...8" ~ 3e-8,
			concentration_M == "...9" ~ 1e-8,
			concentration_M == "...10" ~ 3e-9,
			T ~ NA_real_
		)) %>%
		bind_rows(DMSO_vals)
	
	return(temp_plate)
}

plate_vals = bind_rows(
	read_plate_data(here('data/PDAC_validation_screen_part2/119_1.xlsx'),c("Masitinib","Ripasudil"),"CAF"),
	read_plate_data(here('data/PDAC_validation_screen_part2/119_2.xlsx'),c("AT-13148","RGB-286638"),"CAF"),
	read_plate_data(here('data/PDAC_validation_screen_part2/119_3.xlsx'),c("PHA-793887","AT-9283"),"CAF"),
	read_plate_data(here('data/PDAC_validation_screen_part2/119_4.xlsx'),c("Lestaurtinib","KW-2449"),"CAF"),
	read_plate_data(here('data/PDAC_validation_screen_part2/119_5.xlsx'),c("K-252a","PF-03814735"),"CAF"),
	read_plate_data(here('data/PDAC_validation_screen_part2/119_6.xlsx'),c("XL-228","JANEX-1"),"CAF"),
	
	read_plate_data(here('data/PDAC_validation_screen_part2/411_1.xlsx'),c("Masitinib","Ripasudil"),"P1304"),
	read_plate_data(here('data/PDAC_validation_screen_part2/411_2.xlsx'),c("AT-13148","RGB-286638"),"P1304"),
	read_plate_data(here('data/PDAC_validation_screen_part2/411_3.xlsx'),c("PHA-793887","AT-9283"),"P1304"),
	read_plate_data(here('data/PDAC_validation_screen_part2/411_4.xlsx'),c("Lestaurtinib","KW-2449"),"P1304"),
	read_plate_data(here('data/PDAC_validation_screen_part2/411_5.xlsx'),c("K-252a","PF-03814735"),"P1304"),
	read_plate_data(here('data/PDAC_validation_screen_part2/411_6.xlsx'),c("XL-228","JANEX-1"),"P1304"),
	
	read_plate_data(here('data/PDAC_validation_screen_part2/422_1.xlsx'),c("Masitinib","Ripasudil"),"P1004"),
	read_plate_data(here('data/PDAC_validation_screen_part2/422_2.xlsx'),c("AT-13148","RGB-286638"),"P1004"),
	read_plate_data(here('data/PDAC_validation_screen_part2/422_3.xlsx'),c("PHA-793887","AT-9283"),"P1004"),
	read_plate_data(here('data/PDAC_validation_screen_part2/422_4.xlsx'),c("Lestaurtinib","KW-2449"),"P1004"),
	read_plate_data(here('data/PDAC_validation_screen_part2/422_5.xlsx'),c("K-252a","PF-03814735"),"P1004"),
	read_plate_data(here('data/PDAC_validation_screen_part2/422_6.xlsx'),c("XL-228","JANEX-1"),"P1004"),
)

plate_vals_part1 = bind_rows(
	read_plate_data(here('data/PDAC_validation_screen_part1/411_1.xlsx'),c("Masitinib","Ripasudil"),"P1304", skip_lines = 14),
	read_plate_data(here('data/PDAC_validation_screen_part1/411_2.xlsx'),c("AT-13148","RGB-286638"),"P1304", skip_lines = 14),
	read_plate_data(here('data/PDAC_validation_screen_part1/411_3.xlsx'),c("PHA-793887","AT-9283"),"P1304", skip_lines = 14),
	read_plate_data(here('data/PDAC_validation_screen_part1/411_4.xlsx'),c("Lestaurtinib","KW-2449"),"P1304", skip_lines = 14),
	read_plate_data(here('data/PDAC_validation_screen_part1/411_5a.xlsx'),c("PF-03814735","XL-228"),"P1304", skip_lines = 14),
	
	read_plate_data(here('data/PDAC_validation_screen_part1/422_1.xlsx'),c("Masitinib","Ripasudil"),"P1004", skip_lines = 14),
	read_plate_data(here('data/PDAC_validation_screen_part1/422_2.xlsx'),c("AT-13148","RGB-286638"),"P1004", skip_lines = 14),
	read_plate_data(here('data/PDAC_validation_screen_part1/422_3.xlsx'),c("PHA-793887","AT-9283"),"P1004", skip_lines = 14),
	read_plate_data(here('data/PDAC_validation_screen_part1/422_4.xlsx'),c("Lestaurtinib","KW-2449"),"P1004", skip_lines = 14),
	read_plate_data(here('data/PDAC_validation_screen_part1/422_5a.xlsx'),c("PF-03814735","XL-228"),"P1004", skip_lines = 14),
)

if (any(is.na(plate_vals$concentration_M))) {
	stop("Found missing concentration value, this shouldn't happen.")
}
	
```

# Per Plate DMSO Boxplots

```{r}
temp = plate_vals %>%
	filter(compound == "DMSO") %>%
	bind_rows(
		plate_vals_part1 %>%
			filter(compound == "DMSO") %>%
			mutate(plate_name = paste0("p1_",plate_name))
	)

ggplot(temp, aes(x=plate_name,y=lum)) + 
	geom_boxplot() +
	ylim(c(min(plate_vals$lum), NA)) +
	theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```


```{r}
treatment_lum_summaries = plate_vals %>% 
	group_by(compound, concentration_M, cell_line) %>%
	summarise(sd = sd(lum),
						num_samples = n(),
						mean_lum = mean(lum),
						CV = sd/mean_lum)

ggplot(treatment_lum_summaries, aes(x=CV)) + geom_histogram()
```

```{r}
plate_DMSO_means = plate_vals %>%
	filter(compound == "DMSO") %>%
	group_by(plate_name) %>%
	summarise(DMSO_mean = mean(lum),
						num_DMSO = n())

if (! all(plate_DMSO_means$num_DMSO == max(plate_DMSO_means$num_DMSO))) {
	stop("Number of DMSO values in a plate isn't correct.")
} else {
	plate_DMSO_means = plate_DMSO_means %>% select(-num_DMSO)
}
```

```{r}
dir.create(here('results/validation_results/'), showWarnings = F)

plate_vals = plate_vals %>%
	left_join(plate_DMSO_means) %>%
	mutate(viability = lum/DMSO_mean*100) %>%
	write_rds(here('results/validation_results/validation_screen.rds'))

treatment_via_summaries = plate_vals %>% 
	group_by(compound, concentration_M, cell_line) %>%
	summarise(sd = sd(viability),
						num_samples = n(),
						mean_via = mean(viability),
						CV = sd/mean_via)

DMSO_via = plate_vals %>%
	filter(compound == "DMSO")
```

```{r}
ggplot(plate_vals %>% filter(compound != "DMSO"), aes(x=concentration_M, y = viability)) +
	geom_hline(aes(yintercept = 90),alpha=0.5) +
	scale_x_log10() +
	geom_jitter() +
	geom_smooth() +
	BerginskiRMisc::theme_berginski() +
	facet_grid(rows = vars(cell_line), cols = vars(compound))

ggsave(here('figures/validation_testing/validation_viability.png'),width=18*0.75,height=5*0.75)
BerginskiRMisc::trimImage(here('figures/validation_testing/validation_viability.png'))
```

```{r}
compound_order = c("Masitinib","Ripasudil","AT-13148","RGB-286638","PHA-793887","AT-9283","Lestaurtinib","K-252a","PF-03814735","XL-228")

ggplot(plate_vals %>% filter(compound %in% compound_order) %>%
			 	mutate(compound = fct_relevel(compound, compound_order)), aes(x=concentration_M, y = viability, color=cell_line)) +
	geom_hline(aes(yintercept = 90),alpha=0.5) +
	scale_x_log10() +
	geom_jitter() +
	geom_smooth() +
	BerginskiRMisc::theme_berginski() +
	facet_grid(cols = vars(compound))

ggsave(here('figures/validation_testing/validation_viability_cell_line.png'),width=18*0.75,height=3*0.75)
BerginskiRMisc::trimImage(here('figures/validation_testing/validation_viability_cell_line.png'))
```

```{r}
low_plots = ggplot(plate_vals %>% 
									 	filter(compound %in% c("Masitinib","Ripasudil","AT-13148")) %>%
									 	mutate(compound = fct_relevel(compound,c("Masitinib","Ripasudil","AT-13148"))), 
									 aes(x=concentration_M, y = viability, color=cell_line)) +
	geom_hline(aes(yintercept = 90),alpha=0.5) +
	scale_x_log10() +
	geom_jitter() +
	geom_smooth() +
	BerginskiRMisc::theme_berginski() +
	facet_grid(cols = vars(compound))

high_eff_plots = ggplot(plate_vals %>% 
									 	filter(compound %in% c("TG-100572","RGB-286638","PHA-793887")) %>%
									 	mutate(compound = fct_relevel(compound,c("RGB-286638","PHA-793887"))), 
									 aes(x=concentration_M, y = viability, color=cell_line)) +
	geom_hline(aes(yintercept = 90),alpha=0.5) +
	scale_x_log10() +
	geom_jitter() +
	geom_smooth() +
	BerginskiRMisc::theme_berginski() +
	facet_grid(cols = vars(compound))

concen_plots = ggplot(plate_vals %>% 
									 	filter(compound %in% c("AT-9283","Lestaurtinib","TAK-901")) %>%
									 	mutate(compound = fct_relevel(compound,c("AT-9283","Lestaurtinib"))), 
									 aes(x=concentration_M, y = viability, color=cell_line)) +
	geom_hline(aes(yintercept = 90),alpha=0.5) +
	scale_x_log10() +
	geom_jitter() +
	geom_smooth() +
	BerginskiRMisc::theme_berginski() +
	facet_grid(cols = vars(compound))

cell_line_plots = ggplot(plate_vals %>% 
									 	filter(compound %in% c("K-252a","PF-03814735","XL-228")) %>%
									 	mutate(compound = fct_relevel(compound,c("K-252a","PF-03814735","XL-228"))), 
									 aes(x=concentration_M, y = viability, color=cell_line)) +
	geom_hline(aes(yintercept = 90),alpha=0.5) +
	scale_x_log10() +
	geom_jitter() +
	geom_smooth() +
	BerginskiRMisc::theme_berginski() +
	facet_grid(cols = vars(compound))
```


# Part 1 Processing

```{r}
plate_DMSO_means_p1 = plate_vals_part1 %>%
	filter(compound == "DMSO") %>%
	group_by(plate_name) %>%
	summarise(DMSO_mean = mean(lum))

plate_vals_part1 = plate_vals_part1 %>%
	left_join(plate_DMSO_means_p1) %>%
	mutate(viability = lum/DMSO_mean*100)
```

```{r}
ggplot(plate_vals_part1 %>% filter(compound != "DMSO"), aes(x=concentration_M, y = viability)) +
	geom_hline(aes(yintercept = 90),alpha=0.5) +
	scale_x_log10() +
	geom_jitter() +
	geom_smooth() +
	BerginskiRMisc::theme_berginski() +
	facet_grid(rows = vars(cell_line), cols = vars(compound))

ggsave(here('figures/validation_testing/validation_viability_p1.png'),width=18*0.75,height=5*0.75)
BerginskiRMisc::trimImage(here('figures/validation_testing/validation_viability_p1.png'))
```

```{r}
plate_val_summary = plate_vals %>%
	group_by(compound,concentration_M,cell_line) %>%
	summarise(mean_via = mean(viability), .groups = "drop")

plate_val_p1_summary = plate_vals_part1 %>%
	group_by(compound,concentration_M,cell_line) %>%
	summarise(mean_via_p1 = mean(viability), .groups = "drop")


comparison = plate_val_summary %>%
	left_join(plate_val_p1_summary) %>%
	filter(!is.na(mean_via_p1)) %>%
	mutate(viability_diff = mean_via - mean_via_p1)

average_error = comparison %>%
	group_by(compound, cell_line) %>%
	summarise(compound_err = mean(viability_diff))
	
	# left_join(plate_vals_part1 %>% 
	# 						select(compound,concentration_M,cell_line,viability) %>%
	# 						rename(viability_p1 = viability)) %>%
	# filter(!is.na(viability_p1)) %>%
	# mutate(viability_diff = viability - viability_p1)


```
